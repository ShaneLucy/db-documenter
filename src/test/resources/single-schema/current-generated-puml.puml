@startuml
hide methods
hide stereotypes

package "public" {
	entity "order_status" <<enum>> {
		pending
		paid
		shipped
		cancelled
		refunded
	}

	entity "app_user" {
		**id: uuid**
		--
		username: character varying(50)
		email: character varying(255)
		display_name: character varying(100)?
		birth_date: date?
		created_at: timestamp with time zone
		profile: jsonb?
		is_active: boolean
	}

	entity "user_role" {
		__**user_id: uuid**__ '→ app_user.id
		__**role_id: smallint**__ '→ role.id
		--
		assigned_at: timestamp with time zone
		__assigned_by: uuid__ '→ app_user.id?
	}

	entity "role" {
		**id: smallint**
		--
		code: character varying(50)
		description: character varying(255)?
	}

	entity "address" {
		**id: bigint**
		--
		__user_id: uuid__ '→ app_user.id
		line1: character varying(200)
		line2: character varying(200)?
		city: character varying(100)
		state: character varying(100)?
		postal_code: character varying(20)?
		country: character(2)
		created_at: timestamp with time zone
	}

	entity "product" {
		**id: bigint**
		--
		sku: character varying(30)
		name: character varying(200)
		description: text?
		price: numeric
		attributes: jsonb?
		created_at: timestamp without time zone
		stock: integer
	}

	entity "product_category" {
		__**product_id: bigint**__ '→ product.id
		__**category_id: smallint**__ '→ category.id
		--
		assigned_at: timestamp with time zone
	}

	entity "category" {
		**id: smallint**
		--
		slug: character varying(80)
		title: character varying(120)
		metadata: jsonb?
	}

	entity "customer_order" {
		**id: bigint**
		--
		__user_id: uuid__ '→ app_user.id?
		order_number: character varying(30)
		order_date: timestamp with time zone
		ship_date: timestamp without time zone?
		__shipping_address_id: bigint__ '→ address.id?
		status: order_status
		total: numeric
		metadata: jsonb?
	}

	entity "order_item" {
		**id: bigint**
		--
		__order_id: bigint__ '→ customer_order.id
		__product_id: bigint__ '→ product.id
		product_snapshot: jsonb
		unit_price: numeric
		quantity: integer
		line_total: numeric
	}

	entity "payment" {
		**id: uuid**
		--
		__order_id: bigint__ '→ customer_order.id
		paid_at: timestamp with time zone
		amount: numeric
		method: character varying(50)
		provider_transaction_id: character varying(255)?
		raw_response: jsonb?
	}

	entity "audit_log" {
		**id: bigint**
		--
		entity_type: character varying(100)
		entity_id: text
		action: character varying(50)
		__performed_by: uuid__ '→ app_user.id?
		performed_at: timestamp with time zone
		details: jsonb?
	}

	entity "tag_log" {
		tag_id: character varying(50)
		logged_at: timestamp with time zone
	}

}

app_user ||--|{ user_role
role ||--|{ user_role
app_user ||--o{ user_role
app_user ||--|{ address
product ||--|{ product_category
category ||--|{ product_category
app_user ||--o{ customer_order
address ||--o{ customer_order
customer_order ||--|{ order_item
product ||--|{ order_item
customer_order ||--|{ payment
app_user ||--o{ audit_log
@enduml
