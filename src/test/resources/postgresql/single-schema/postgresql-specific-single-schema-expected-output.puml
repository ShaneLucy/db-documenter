@startuml
hide methods
hide stereotypes

package "public" {
	entity "order_status" <<enum>> {
		pending
		paid
		shipped
		cancelled
		refunded
	}

	entity "app_user" {
		**id: uuid** <<DEFAULT>>
		--
		username: character varying(50) <<UNIQUE,CHECK>>
		email: character varying(255) <<UNIQUE>>
		display_name: character varying(100) <<NULLABLE>>
		birth_date: date <<NULLABLE>>
		created_at: timestamp with time zone <<DEFAULT>>
		profile: jsonb <<DEFAULT,NULLABLE>>
		is_active: boolean <<DEFAULT>>
	}

	entity "role" {
		**id: smallint** <<AUTO_INCREMENT,DEFAULT>>
		--
		code: character varying(50) <<UNIQUE>>
		description: character varying(255) <<NULLABLE>>
	}

	entity "user_role" {
		**user_id: uuid** <<FK>>
		**role_id: smallint** <<FK>>
		--
		assigned_at: timestamp with time zone <<DEFAULT>>
		assigned_by: uuid <<FK,NULLABLE>>
	}

	entity "address" {
		**id: bigint** <<AUTO_INCREMENT,DEFAULT>>
		--
		user_id: uuid <<FK>>
		line1: character varying(200)
		line2: character varying(200) <<NULLABLE>>
		city: character varying(100)
		state: character varying(100) <<NULLABLE>>
		postal_code: character varying(20) <<NULLABLE>>
		country: character(2) <<CHECK>>
		created_at: timestamp with time zone <<DEFAULT>>
	}

	entity "product" {
		**id: bigint** <<AUTO_INCREMENT,DEFAULT>>
		--
		sku: character varying(30) <<UNIQUE>>
		name: character varying(200)
		description: text <<NULLABLE>>
		price: numeric(19,2) <<CHECK>>
		attributes: jsonb <<DEFAULT,NULLABLE>>
		created_at: timestamp without time zone <<DEFAULT>>
		stock: integer <<DEFAULT>>
	}

	entity "category" {
		**id: smallint** <<AUTO_INCREMENT,DEFAULT>>
		--
		slug: character varying(80) <<UNIQUE>>
		title: character varying(120)
		metadata: jsonb <<DEFAULT,NULLABLE>>
	}

	entity "product_category" {
		**product_id: bigint** <<FK>>
		**category_id: smallint** <<FK>>
		--
		assigned_at: timestamp with time zone <<DEFAULT>>
	}

	entity "customer_order" {
		**id: bigint** <<AUTO_INCREMENT,DEFAULT>>
		--
		user_id: uuid <<FK,NULLABLE>>
		order_number: character varying(30) <<UNIQUE>>
		order_date: timestamp with time zone <<DEFAULT>>
		ship_date: timestamp without time zone <<NULLABLE>>
		shipping_address_id: bigint <<FK,NULLABLE>>
		status: order_status <<DEFAULT>>
		total: numeric(19,2) <<CHECK>>
		metadata: jsonb <<DEFAULT,NULLABLE>>
	}

	entity "order_item" {
		**id: bigint** <<AUTO_INCREMENT,DEFAULT>>
		--
		order_id: bigint <<FK,UNIQUE:uq_order_product>>
		product_id: bigint <<FK,UNIQUE:uq_order_product>>
		product_snapshot: jsonb
		unit_price: numeric(19,2) <<CHECK>>
		quantity: integer <<CHECK>>
		line_total: numeric(19,2) <<CHECK>>
	}

	entity "payment" {
		**id: uuid** <<DEFAULT>>
		--
		order_id: bigint <<FK>>
		paid_at: timestamp with time zone <<DEFAULT>>
		amount: numeric(19,2) <<CHECK>>
		method: character varying(50)
		provider_transaction_id: character varying(255) <<NULLABLE>>
		raw_response: jsonb <<NULLABLE>>
	}

	entity "audit_log" {
		**id: bigint** <<AUTO_INCREMENT,DEFAULT>>
		--
		entity_type: character varying(100)
		entity_id: text
		action: character varying(50)
		performed_by: uuid <<FK,NULLABLE>>
		performed_at: timestamp with time zone <<DEFAULT>>
		details: jsonb <<NULLABLE>>
	}

	entity "tag_log" {
		tag_id: character varying(50)
		logged_at: timestamp with time zone <<DEFAULT>>
	}

	entity "product_status" {
		**id: smallint**
		--
		code: character varying(50) <<UNIQUE>>
	}

	entity "product_listing" {
		**id: bigint** <<AUTO_INCREMENT,DEFAULT>>
		--
		listed_by: uuid <<FK,NULLABLE>>
		product_id: bigint <<FK,NULLABLE>>
		status_id: smallint <<FK,DEFAULT>>
		title: character varying(200)
		listed_at: timestamp with time zone <<DEFAULT>>
	}

}

address ||--o{ customer_order

app_user ||--|{ user_role : "ON DELETE CASCADE"
app_user ||--o{ user_role
app_user ||--|{ address : "ON DELETE CASCADE"
app_user ||--o{ customer_order
app_user ||--o{ audit_log
app_user ||--o{ product_listing : "ON DELETE RESTRICT / ON UPDATE RESTRICT"

category ||--|{ product_category : "ON DELETE CASCADE"

customer_order ||--|{ order_item : "ON DELETE CASCADE"
customer_order ||--|{ payment : "ON DELETE CASCADE"

product ||--|{ product_category : "ON DELETE CASCADE"
product ||--|{ order_item
product ||--o{ product_listing : "ON DELETE SET NULL / ON UPDATE SET NULL"

product_status ||--|{ product_listing : "ON DELETE SET DEFAULT / ON UPDATE SET DEFAULT"

role ||--|{ user_role : "ON DELETE CASCADE"

@enduml
